<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Account ‚Äî Phi Ai</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    /* Page-specific: Preserve JS functionality for dynamic org/position fields */
    .dropdown-content {
      display: none !important;
    }
    
    .dropdown-content.show {
      display: block !important;
    }
    
    .dropbtn {
      pointer-events: auto !important;
      z-index: 1;
      position: relative;
    }
    
    .dropdown {
      z-index: 100;
      position: relative;
    }

    .dropdown-content a:hover {
      background-color: var(--bg-secondary);
    }
    
    .org-entry, .position-entry {
      margin-bottom: var(--space-md);
      padding: var(--space-md);
      background: var(--bg-secondary);
      border-radius: var(--border-radius);
      border: 1px solid var(--border-light);
    }
    
    .section-label {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: var(--space-sm);
      margin-top: var(--space-xl);
    }
  </style>
</head>
<body>
  <!-- Animated Wave Background -->
  <div class="bg-waves{% if waves_debug %} debug-mode{% endif %}" aria-hidden="true"></div>
  {% if waves_debug %}
  <div class="waves-debug-badge">üåä WAVES ON</div>
  {% endif %}
  
  <div class="app-container">
    <!-- Header -->
    <header class="header">
      <div class="header-inner">
        <a href="{{ url_for('account_home') }}" class="header-brand">
          <img src="{{ url_for('static', filename='images/logo.png.png') }}" alt="Phi AI" class="header-logo">
        </a>
        <nav class="header-nav">
          <a href="{{ url_for('account_home') }}" class="header-link">Dashboard</a>
          <a href="{{ url_for('account_meetings') }}" class="header-link">Meetings</a>
          {% if phi_available %}
          <a href="{{ url_for('ask_get') }}" class="header-link">Ask Phi</a>
          {% else %}
            <a href="#" class="header-link" aria-disabled="true" title="Phi is starting up" onclick="return false;" style="opacity: 0.5; cursor: not-allowed;">Ask Phi</a>
          {% endif %}
          <a href="{{ url_for('connect_apps_get') }}" class="header-link">Connect Apps</a>
          <a href="{{ url_for('account_get') }}" class="header-link active">Settings</a>
          <a href="{{ url_for('vocabulary_get') }}" class="header-link">Custom Vocabulary</a>
          <a href="{{ url_for('logout') }}" class="header-link" onclick="return confirm('Are you sure you want to logout?')">Logout</a>
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content main-content-narrow enter">
      <!-- Flash Messages -->
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <div class="alert alert-success enter">
            {% for m in messages %}
              {{ m }}{% if not loop.last %}<br>{% endif %}
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- Settings Navigation -->
      <div class="card holo-border enter" style="margin-bottom: var(--space-lg);">
        <div class="card-body" style="padding: var(--space-md);">
          <nav style="display: flex; gap: var(--space-md); flex-wrap: wrap;">
            <a href="{{ url_for('account_get') }}" class="header-link" style="padding: var(--space-sm) var(--space-md); border-radius: var(--border-radius-sm); {% if request.endpoint == 'account_get' %}background: var(--accent); color: white;{% else %}background: var(--bg-secondary);{% endif %}">Account</a>
            <a href="{{ url_for('vocabulary_get') }}" class="header-link" style="padding: var(--space-sm) var(--space-md); border-radius: var(--border-radius-sm); {% if request.endpoint == 'vocabulary_get' %}background: var(--accent); color: white;{% else %}background: var(--bg-secondary);{% endif %}">Custom Vocabulary</a>
          </nav>
        </div>
      </div>

      <!-- Account Settings Form -->
      <form method="post" action="{{ url_for('account_post') }}" class="card holo-border enter enter-delay-1">
        <div class="card-header">
          <h2 class="card-title">Account Settings</h2>
        </div>
        
        <div class="card-body">
          <div class="alert alert-info">
            Update your account information and voice enrollment settings.
          </div>

          <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: var(--space-xl);">Save Changes</button>

          <div class="form-group">
            <label for="first" class="form-label required">First name</label>
            <input id="first" name="first" type="text" class="form-input" value="{{ user.first }}" required placeholder="First name">
          </div>

          <div class="form-group">
            <label for="last" class="form-label required">Last name</label>
            <input id="last" name="last" type="text" class="form-input" value="{{ user.last }}" required placeholder="Last name">
          </div>

          <div class="form-group">
            <label for="email" class="form-label required">Email</label>
            <input id="email" name="email" type="email" class="form-input" value="{{ user.email }}" required placeholder="your.email@example.com" autocomplete="email">
          </div>

          <div class="form-group">
            <label for="email2" class="form-label required">Confirm email</label>
            <input id="email2" name="email2" type="email" class="form-input" value="{{ user.email }}" required placeholder="your.email@example.com" autocomplete="email">
          </div>

          <div class="form-group">
            <label for="username_display" class="form-label">Username</label>
            <input id="username_display" name="username_display" type="text" class="form-input" value="{{ user.username if user.username else 'Not set' }}" disabled style="background: var(--bg-secondary); color: var(--text-secondary); cursor: not-allowed;" placeholder="Username">
            <div class="form-helper">
              Your username cannot be changed. It is used to identify your voice recordings.
            </div>
          </div>

          <hr style="margin: var(--space-xl) 0; border: none; border-top: 1px solid var(--border-light);">

          <div class="section-label" style="margin-bottom: var(--space-md);">
            Your Current Positions
            <div class="form-helper" style="margin-top: var(--space-xs);">
              Your current organizations and positions. Click "Add/Edit Positions" below to manage them.
            </div>
          </div>

          <div id="currentPositionsContainer" style="margin-bottom: var(--space-lg);">
            {% if user.organizations %}
              {% for org in user.organizations %}
              <div class="position-item enter" style="background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: var(--border-radius); padding: var(--space-lg); margin-bottom: var(--space-md); box-shadow: var(--shadow-sm);" data-position-index="{{ loop.index0 }}">
                <div style="flex: 1;">
                  <div style="font-weight: var(--font-weight-bold); font-size: var(--font-size-md); color: var(--text-primary); margin-bottom: var(--space-xs); display: flex; align-items: center; gap: var(--space-sm);">
                    <span style="font-size: var(--font-size-lg);">üíº</span>
                    <span>{{ org.name }}</span>
                    {% if org.role %}
                    <span class="badge badge-success" style="font-weight: var(--font-weight-medium); font-size: var(--font-size-sm); padding: var(--space-xs) var(--space-sm);">{{ org.role }}</span>
                    {% endif %}
                  </div>
                  <div style="font-size: var(--font-size-xs); color: var(--text-tertiary); margin-left: calc(var(--space-lg) + var(--space-sm));">
                    {% set dir_org = organizations_directory | selectattr("name", "equalto", org.name) | first %}
                    {% if dir_org %}
                      üìç {{ dir_org.address }}
                    {% elif org.address %}
                      üìç {{ org.address }}
                    {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            {% else %}
              <div style="padding: var(--space-lg); text-align: center; color: var(--text-secondary); font-size: var(--font-size-sm); background: var(--bg-secondary); border-radius: var(--border-radius); border: 1px dashed var(--border-light);">
                No current positions
              </div>
            {% endif %}
          </div>

          <div style="margin-bottom: var(--space-lg);">
            <a href="{{ url_for('edit_positions') }}" class="btn btn-secondary" style="display: inline-block; text-decoration: none; text-align: center;">Add/Edit Positions</a>
          </div>

          <hr style="margin: var(--space-xl) 0; border: none; border-top: 1px solid var(--border-light);">

          <div class="section-label">Change password (optional)</div>
          <div class="form-group">
            <label for="password" class="form-label">New password</label>
            <input id="password" name="password" type="password" class="form-input" minlength="8" placeholder="Leave blank to keep current" autocomplete="new-password">
          </div>

          <div class="form-group">
            <label for="password2" class="form-label">Confirm new password</label>
            <input id="password2" name="password2" type="password" class="form-input" minlength="8" placeholder="Leave blank to keep current" autocomplete="new-password">
          </div>

          <hr style="margin: var(--space-xl) 0; border: none; border-top: 1px solid var(--border-light);">

          <div class="section-label">Speaker Identification</div>
          <div class="form-group">
            <label for="speaker_confidence" class="form-label">Confidence Threshold</label>
            <div style="padding: var(--space-md); background: var(--bg-secondary); border-radius: var(--border-radius);">
              <select id="speaker_confidence" name="speaker_confidence" class="form-input" style="margin-bottom: var(--space-sm);">
                <option value="strict" {% if user.get('speaker_confidence', 'normal') == 'strict' %}selected{% endif %}>Strict (0.75) ‚Äî Fewer matches, higher accuracy</option>
                <option value="normal" {% if user.get('speaker_confidence', 'normal') == 'normal' %}selected{% endif %}>Normal (0.65) ‚Äî Balanced (default)</option>
                <option value="relaxed" {% if user.get('speaker_confidence', 'normal') == 'relaxed' %}selected{% endif %}>Relaxed (0.55) ‚Äî More matches, may have errors</option>
                <option value="permissive" {% if user.get('speaker_confidence', 'normal') == 'permissive' %}selected{% endif %}>Permissive (0.45) ‚Äî Most matches, lower accuracy</option>
              </select>
              <div style="font-size: var(--font-size-xs); color: var(--text-secondary); line-height: 1.5;">
                Lower thresholds will identify more speakers but may make mistakes. Use "Relaxed" or "Permissive" if speakers are frequently showing as "Unknown" despite having enrollment audio.
              </div>
            </div>
          </div>

          <hr style="margin: var(--space-xl) 0; border: none; border-top: 1px solid var(--border-light);">

          <div class="section-label">Email Preferences</div>
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: var(--space-md); padding: var(--space-md); background: var(--bg-secondary); border-radius: var(--border-radius); cursor: pointer;">
              <input type="checkbox" name="receive_meeting_emails" {% if user.get('receive_meeting_emails', True) %}checked{% endif %} style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--accent);">
              <div style="flex: 1;">
                <div style="font-weight: var(--font-weight-medium); color: var(--text-primary); margin-bottom: var(--space-xs);">Receive meeting emails</div>
                <div style="font-size: var(--font-size-xs); color: var(--text-secondary);">Get email notifications with transcripts when meetings you're in are processed</div>
              </div>
            </label>
          </div>
        </div>
      </form>

      <div class="card holo-border enter enter-delay-2" style="margin-top: var(--space-xl);">
        <div class="card-body" style="display: flex; flex-direction: column; gap: var(--space-md);">
          <a href="{{ url_for('enroll_get') }}" class="btn btn-primary" style="text-align: center; text-decoration: none; display: block;">Upload/Record New Audio</a>
          <a href="{{ url_for('logout') }}" class="text-center text-muted" style="text-align: center; display: block;" onclick="return confirm('Are you sure you want to logout?')">Logout</a>
        </div>
      </div>

      <div class="card enter enter-delay-3" style="border: 2px solid var(--error); background: var(--error-light); margin-top: var(--space-lg);">
        <div class="card-header">
          <h2 class="card-title" style="color: var(--error); font-size: var(--font-size-md);">‚ö†Ô∏è Danger Zone</h2>
        </div>
        <div class="card-body">
          <p style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: var(--space-md); line-height: var(--line-height-relaxed);">
            Deleting your account will permanently remove all your data, including your enrollment audio, organization memberships, and meeting history. This action cannot be undone.
          </p>
          <button type="button" onclick="deleteAccount()" class="btn btn-danger" style="width: 100%;">
            Delete Account
          </button>
        </div>
      </div>

      <div class="text-center" style="margin-top: var(--space-lg);">
        <a href="{{ url_for('account_home') }}" class="text-muted">‚Üê Back to Home</a>
      </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="footer-inner">
        <p>&copy; 2026 Phi AI. All rights reserved.</p>
        <p style="margin-top: var(--space-sm); font-size: var(--font-size-sm); color: var(--text-secondary);">189 Vassar St, Cambridge, MA 02139</p>
      </div>
    </footer>
  </div>

<script type="application/json" id="org-types-data">{{ org_types | tojson | safe }}</script>
<script type="application/json" id="user-orgs-data">{{ (user.organizations or []) | tojson | safe }}</script>
<script type="application/json" id="org-directory-data">{{ organizations_directory | tojson | safe }}</script>
<script>
let orgCount = 0;
// Load organization types, user orgs, and directory from template
const orgTypes = JSON.parse(document.getElementById('org-types-data').textContent);
const userOrgs = JSON.parse(document.getElementById('user-orgs-data').textContent);
const orgDirectory = JSON.parse(document.getElementById('org-directory-data').textContent);

// Initialize with existing organizations
document.addEventListener("DOMContentLoaded", () => {
  userOrgs.forEach(org => {
    // Look up organization in directory to get display name and address
    const dirOrg = orgDirectory.find(o => o.name === org.name);
    const displayName = dirOrg && dirOrg.abbreviation ? `${org.name} (${dirOrg.abbreviation})` : org.name;
    const address = dirOrg ? dirOrg.address : (org.address || "");
    addOrganization(org.name, displayName, address, org.type, org.role);
  });
  
  // If no organizations, add one empty one (required to have at least 1)
  if (orgCount === 0) {
    addOrganization();
  }
  
});

function addOrganization(actualName = "", displayName = "", address = "", type = "", role = "") {
  if (orgCount >= 10) {
    alert("You can add up to 10 organizations.");
    return;
  }

  const container = document.getElementById("organizationsContainer");
  const orgIndex = orgCount;
  orgCount++;
  document.getElementById("orgCount").value = orgCount;

  const orgDiv = document.createElement("div");
  orgDiv.className = "org-entry";
  orgDiv.style.cssText = "margin-bottom: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-light);";
  orgDiv.id = `org_${orgIndex}`;

  const orgTypeKeys = Object.keys(orgTypes);
  const typeOptions = orgTypeKeys.map(key => 
    `<option value="${key}" ${type === key ? 'selected' : ''}>${orgTypes[key].name}</option>`
  ).join("");
  
  const roles = type ? (orgTypes[type]?.roles || []) : [];
  const roleOptions = roles.map(r => 
    `<option value="${r}" ${role === r ? 'selected' : ''}>${r}</option>`
  ).join("");
  
  const canRemove = orgCount > 1; // Can only remove if more than 1 organization

  // Build select options
  let selectOptions = '<option value="">Select or search organizations...</option>';
  if (actualName) {
    const dirOrg = orgDirectory.find(o => o.name === actualName);
    const orgDisplayName = dirOrg && dirOrg.abbreviation ? `${actualName} (${dirOrg.abbreviation})` : actualName;
    selectOptions = `<option value="${actualName}" selected>${orgDisplayName}</option>`;
  }

  orgDiv.innerHTML = `
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
      <strong style="font-size: 14px; color: var(--text-primary);">Organization ${orgIndex + 1}</strong>
      ${canRemove ? `<button type="button" onclick="removeOrganization(${orgIndex})" style="background: #FF3B30; color: #ffffff; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px; font-weight: 500; transition: background 0.2s; width: auto; min-width: auto;" onmouseover="this.style.background='#e0291f'" onmouseout="this.style.background='#FF3B30'">Remove</button>` : '<span style="font-size: 12px; color: var(--text-secondary);">Required</span>'}
    </div>
    
    <div style="margin-bottom: 12px;">
      <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Organization Name</label>
      <div class="dropdown" style="position: relative; display: inline-block; width: 100%;">
        <button type="button" id="org_dropbtn_${orgIndex}" class="dropbtn" onclick="toggleOrgDropdown(${orgIndex}); return false;" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: white; color: var(--text-primary); text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 1;">
          <span id="org_dropbtn_text_${orgIndex}">${displayName || "Select or search organizations..."}</span>
          <span style="color: var(--text-secondary);">‚ñº</span>
        </button>
        <div id="org_dropdown_${orgIndex}" class="dropdown-content" style="display: none; position: absolute; background-color: white; min-width: 100%; width: 100%; border: 1px solid var(--border); border-radius: 6px; box-shadow: var(--shadow-hover); z-index: 1000; max-height: 300px; overflow-y: auto; top: 100%; left: 0;">
          <input type="text" placeholder="Search organizations..." id="org_search_${orgIndex}" autocomplete="off" style="box-sizing: border-box; background-image: url('data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'16\\' height=\\'16\\' viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'%236e6e73\\' stroke-width=\\'2\\'><circle cx=\\'11\\' cy=\\'11\\' r=\\'8\\'/><path d=\\'m21 21-4.35-4.35\\'/></svg>'); background-position: 14px 12px; background-repeat: no-repeat; font-size: 14px; padding: 14px 20px 12px 45px; border: none; border-bottom: 1px solid var(--border-light); width: 100%;">
          <div id="org_dropdown_list_${orgIndex}"></div>
        </div>
        <input type="hidden" name="org_name_${orgIndex}" id="org_name_${orgIndex}" value="${actualName}" required>
        <input type="hidden" name="org_address_${orgIndex}" id="org_address_${orgIndex}" value="${address}">
      </div>
      <div style="margin-top: 8px;">
        <a href="#" onclick="event.preventDefault(); openAddOrgModal(${orgIndex}); return false;" style="font-size: 12px; color: var(--accent-blue); text-decoration: none;">Don't see your organization/school? Add it here</a>
      </div>
    </div>
    
    <div style="margin-bottom: 12px;">
      <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Type</label>
      <select name="org_type_${orgIndex}" required onchange="updateRoleOptions(${orgIndex})" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
        <option value="">Select type...</option>
        ${typeOptions}
      </select>
    </div>
    
    <div>
      <label style="display: block; margin-bottom: 4px; font-size: 13px; font-weight: 500;">Role</label>
      <select name="org_role_${orgIndex}" required id="org_role_${orgIndex}" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
        ${type ? roleOptions : '<option value="">Select organization type first...</option>'}
      </select>
    </div>
  `;

  container.appendChild(orgDiv);
  
  // If type is already set, initialize role options
  if (type) {
    updateRoleOptions(orgIndex);
    // Set selected role
    setTimeout(() => {
      const roleSelect = document.getElementById(`org_role_${orgIndex}`);
      if (roleSelect && role) {
        roleSelect.value = role;
      }
    }, 100);
  }
}

// Confirmation Modal
function showConfirmModal(title, message, okText = "OK", cancelText = "Cancel") {
  return new Promise((resolve) => {
    // Create modal if it doesn't exist
    let modal = document.getElementById("confirmModal");
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'confirmModal';
      modal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1001; align-items: center; justify-content: center;';
      document.body.appendChild(modal);
    }
    
    modal.innerHTML = `
      <div style="background: white; border-radius: var(--radius); padding: 24px; max-width: 400px; width: 90%; box-shadow: var(--shadow-hover);">
        <h3 style="margin-bottom: 16px; font-size: 18px; color: var(--text-primary);">${title}</h3>
        <p style="margin-bottom: 20px; font-size: 15px; color: var(--text-secondary);">${message}</p>
        <div style="display: flex; justify-content: flex-end; gap: 12px;">
          <button type="button" id="confirmCancel" class="btn" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border);">${cancelText}</button>
          <button type="button" id="confirmOk" class="btn btnPrimary">${okText}</button>
        </div>
      </div>
    `;
    
    modal.style.display = 'flex';
    
    const okBtn = document.getElementById('confirmOk');
    const cancelBtn = document.getElementById('confirmCancel');
    
    const handleOk = () => {
      modal.style.display = 'none';
      okBtn.onclick = null;
      cancelBtn.onclick = null;
      resolve(true);
    };
    
    const handleCancel = () => {
      modal.style.display = 'none';
      okBtn.onclick = null;
      cancelBtn.onclick = null;
      resolve(false);
    };
    
    okBtn.onclick = handleOk;
    cancelBtn.onclick = handleCancel;
    
    modal.onclick = (e) => {
      if (e.target === modal) {
        handleCancel();
      }
    };
  });
}

async function removeOrganization(index) {
  const orgDiv = document.getElementById(`org_${index}`);
  if (!orgDiv) return;
  
  // Don't allow removing if it's the only one
  if (orgCount <= 1) {
    await showConfirmModal("Cannot Remove Organization", "You must have at least one organization. Please add a new one before removing this one.", "OK");
    return;
  }
  
  const confirmed = await showConfirmModal(
    "Remove Organization",
    "Are you sure you want to remove this organization?",
    "Remove",
    "Cancel"
  );
  
  if (!confirmed) {
    return;
  }
  
  orgDiv.remove();
  orgCount--;
  document.getElementById("orgCount").value = orgCount;
  
  // Reindex remaining organizations
  reindexOrganizations();
}

function reindexOrganizations() {
  const container = document.getElementById("organizationsContainer");
  const entries = container.querySelectorAll(".org-entry");
  entries.forEach((entry, newIndex) => {
    entry.id = `org_${newIndex}`;
    const title = entry.querySelector("strong");
    if (title) title.textContent = `Organization ${newIndex + 1}`;
    
    const canRemove = orgCount > 1;
    const headerDiv = entry.querySelector("div[style*='justify-content: space-between']");
    
    // Update remove button or required span
    let actionElement = entry.querySelector("button[onclick*='removeOrganization']") || entry.querySelector("span[style*='Required']");
    if (canRemove) {
      if (!actionElement || actionElement.tagName === 'SPAN') {
        if (actionElement && actionElement.tagName === 'SPAN') {
          actionElement.outerHTML = `<button type="button" onclick="removeOrganization(${newIndex})" style="background: #FF3B30; color: #ffffff; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px; font-weight: 500; width: auto; min-width: auto;">Remove</button>`;
        }
      } else if (actionElement && actionElement.tagName === 'BUTTON') {
        actionElement.setAttribute("onclick", `removeOrganization(${newIndex})`);
      }
    } else {
      if (!actionElement || actionElement.tagName === 'BUTTON') {
        if (actionElement && actionElement.tagName === 'BUTTON') {
          actionElement.outerHTML = '<span style="font-size: 12px; color: var(--text-secondary);">Required</span>';
        }
      }
    }
    
    // Update all inputs and selects
    const inputs = entry.querySelectorAll("input, select");
    inputs.forEach(input => {
      const name = input.getAttribute("name");
      const id = input.getAttribute("id");
      if (name) {
        const parts = name.split("_");
        if (parts.length >= 2 && !isNaN(parts[parts.length - 1])) {
          const newName = name.substring(0, name.lastIndexOf("_") + 1) + newIndex;
          input.setAttribute("name", newName);
        }
      }
      if (id && id.startsWith("org_role_")) {
        input.setAttribute("id", `org_role_${newIndex}`);
        const typeSelect = entry.querySelector(`select[name*="org_type"]`);
        if (typeSelect) {
          typeSelect.setAttribute("onchange", `updateRoleOptions(${newIndex})`);
        }
      }
      if (id && id.startsWith("org_search_")) {
        input.setAttribute("id", `org_search_${newIndex}`);
        input.setAttribute("onkeyup", `filterOrgDropdown(${newIndex})`);
      }
      if (id && id.startsWith("org_dropbtn_")) {
        input.setAttribute("id", `org_dropbtn_${newIndex}`);
        input.setAttribute("onclick", `toggleOrgDropdown(${newIndex})`);
      }
      if (id && id.startsWith("org_dropbtn_text_")) {
        input.setAttribute("id", `org_dropbtn_text_${newIndex}`);
      }
      if (id && id.startsWith("org_dropdown_list_")) {
        input.setAttribute("id", `org_dropdown_list_${newIndex}`);
      }
      if (id && id.startsWith("org_name_")) {
        input.setAttribute("id", `org_name_${newIndex}`);
        input.setAttribute("name", `org_name_${newIndex}`);
      }
      if (id && id.startsWith("org_address_")) {
        input.setAttribute("id", `org_address_${newIndex}`);
        input.setAttribute("name", `org_address_${newIndex}`);
      }
      if (id && id.startsWith("org_dropdown_")) {
        input.setAttribute("id", `org_dropdown_${newIndex}`);
      }
      if (onclick && onclick.includes("openAddOrgModal")) {
        input.setAttribute("onclick", `openAddOrgModal(${newIndex})`);
      }
    });
  });
}

function updateRoleOptions(index) {
  const typeSelect = document.querySelector(`select[name="org_type_${index}"]`);
  const roleSelect = document.getElementById(`org_role_${index}`);
  
  if (!typeSelect || !roleSelect) return;
  
  const selectedType = typeSelect.value;
  if (!selectedType) {
    roleSelect.innerHTML = '<option value="">Select organization type first...</option>';
    return;
  }
  
  const roles = orgTypes[selectedType]?.roles || [];
  const currentValue = roleSelect.value; // Preserve current selection if valid
  
  roleSelect.innerHTML = roles.map(role => 
    `<option value="${role}" ${role === currentValue ? 'selected' : ''}>${role}</option>`
  ).join("");
  
  // Update organization dropdown when type changes
  const nameInput = document.getElementById(`org_name_${index}`);
  const dropbtnText = document.getElementById(`org_dropbtn_text_${index}`);
  if (nameInput && !nameInput.value && dropbtnText) {
    // Clear organization selection if type changes and no org was selected
    dropbtnText.textContent = "Select or search organizations...";
  }
}

function toggleOrgDropdown(index) {
  const dropdown = document.getElementById(`org_dropdown_${index}`);
  if (!dropdown) {
    return;
  }
  
  const isShowing = dropdown.classList.contains("show");
  
  // Close all other dropdowns first
  document.querySelectorAll('.dropdown-content.show').forEach(dd => {
    if (dd.id !== `org_dropdown_${index}`) {
      dd.classList.remove("show");
      dd.style.display = "none";
    }
  });
  
  if (isShowing) {
    dropdown.classList.remove("show");
    dropdown.style.display = "none";
  } else {
    dropdown.classList.add("show");
    dropdown.style.display = "block";
    populateOrgDropdown(index);
  }
}

// Store all organizations for each dropdown (in-memory copy)
const orgDropdownData = {};

function populateOrgDropdown(index) {
  const listDiv = document.getElementById(`org_dropdown_list_${index}`);
  const searchInput = document.getElementById(`org_search_${index}`);
  
  if (!listDiv) {
    return;
  }
  
  if (typeof orgDirectory === 'undefined' || !orgDirectory || orgDirectory.length === 0) {
    listDiv.innerHTML = '<div style="padding: 12px; color: var(--text-secondary); text-align: center;">No organizations available</div>';
    return;
  }
  
  const typeSelect = document.querySelector(`select[name="org_type_${index}"]`);
  const orgType = typeSelect ? typeSelect.value : null;
  
  // Filter by type if selected
  let filteredOrgs = orgDirectory;
  if (orgType) {
    filteredOrgs = orgDirectory.filter(org => org.type === orgType);
  }
  
  // Sort by popularity
  filteredOrgs.sort((a, b) => (b.popularity || 0) - (a.popularity || 0));
  
  // Store all options in memory for this dropdown
  orgDropdownData[index] = filteredOrgs.map(org => ({
    name: org.name,
    abbreviation: org.abbreviation || '',
    address: org.address || '',
    displayName: org.abbreviation ? `${org.name} (${org.abbreviation})` : org.name
  }));
  
  // Render all options initially
  renderOrgDropdown(index, orgDropdownData[index]);
  
  // Set up search input listener
  if (searchInput) {
    searchInput.value = "";
    
    // Remove all existing event listeners by replacing the input
    const parent = searchInput.parentNode;
    const newInput = searchInput.cloneNode(false); // Clone without children/events
    parent.replaceChild(newInput, searchInput);
    
    // Attach event listener to the new input
    newInput.addEventListener('input', function(e) {
      e.stopPropagation();
      filterOrgDropdown(index);
    });
    
    // Also attach on keyup as backup
    newInput.addEventListener('keyup', function(e) {
      e.stopPropagation();
      filterOrgDropdown(index);
    });
    
    setTimeout(() => newInput.focus(), 100);
  }
}

function renderOrgDropdown(index, orgs) {
  const listDiv = document.getElementById(`org_dropdown_list_${index}`);
  if (!listDiv) return;
  
  if (orgs.length === 0) {
    listDiv.innerHTML = '<div style="padding: 12px; color: var(--text-secondary); text-align: center;">No organizations found</div>';
    return;
  }
  
  // Render all provided organizations
  listDiv.innerHTML = orgs.map(org => {
    const escapedName = org.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    const escapedAddress = (org.address || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
    return `
      <a href="#" data-org-name="${escapedName}" data-org-address="${escapedAddress}" data-org-index="${index}" style="color: var(--text-primary); padding: 12px 16px; text-decoration: none; display: block; border-bottom: 1px solid var(--border-light); cursor: pointer;">
        <div style="font-weight: 500; color: var(--text-primary); font-size: 14px;">${org.displayName}</div>
        <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 4px; line-height: 1.4;">${org.address}</div>
      </a>
    `;
  }).join("");
  
  // Attach click handlers
  listDiv.querySelectorAll('a[data-org-name]').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const name = this.getAttribute('data-org-name');
      const address = this.getAttribute('data-org-address');
      const idx = parseInt(this.getAttribute('data-org-index'));
      selectOrg(idx, name, address);
    });
  });
}

function filterOrgDropdown(index) {
  const searchInput = document.getElementById(`org_search_${index}`);
  if (!searchInput) return;
  
  const q = searchInput.value.trim().toLowerCase();
  
  // Get all organizations from memory
  const all = orgDropdownData[index] || [];
  
  if (!q) {
    // Show all if search is empty
    renderOrgDropdown(index, all);
    return;
  }
  
  // Filter organizations that match the search query
  const filtered = all.filter(org => {
    const searchText = `${org.name} ${org.abbreviation} ${org.address}`.toLowerCase();
    return searchText.includes(q);
  });
  
  // Render filtered results
  renderOrgDropdown(index, filtered);
}

function selectOrg(index, name, address) {
  const nameInput = document.getElementById(`org_name_${index}`);
  const addressInput = document.getElementById(`org_address_${index}`);
  const dropdown = document.getElementById(`org_dropdown_${index}`);
  const dropbtnText = document.getElementById(`org_dropbtn_text_${index}`);
  
  // Find the org in directory to get display name with abbreviation
  const org = orgDirectory.find(o => o.name === name);
  const displayName = org && org.abbreviation ? `${org.name} (${org.abbreviation})` : name;
  
  // Update button text
  dropbtnText.textContent = displayName;
  nameInput.value = name;
  addressInput.value = address;
  dropdown.classList.remove("show");
}

// Close dropdown when clicking outside
window.onclick = function(event) {
  if (!event.target.matches('.dropbtn') && !event.target.closest('.dropdown-content') && !event.target.closest('.dropdown')) {
    const dropdowns = document.getElementsByClassName("dropdown-content");
    for (let i = 0; i < dropdowns.length; i++) {
      const openDropdown = dropdowns[i];
      if (openDropdown.classList.contains('show')) {
        openDropdown.classList.remove('show');
      }
    }
  }
}

function openAddOrgModal(index) {
  // Redirect to add organization page
  const currentUrl = window.location.pathname;
  window.location.href = `{{ url_for('add_organization_get') }}?return_to=${encodeURIComponent(currentUrl)}&org_index=${index}`;
}

async function deleteAccount() {
  // First confirmation
  const firstConfirmed = await showConfirmModal(
    "Delete Account",
    "Are you absolutely sure you want to delete your account? This will permanently delete:\n\n‚Ä¢ All your enrollment audio files\n‚Ä¢ Your organization memberships\n‚Ä¢ Your meeting history\n‚Ä¢ Your chat sessions\n‚Ä¢ Your connected app tokens\n‚Ä¢ Your username and email (they can be reused)\n\nThis action cannot be undone.",
    "Continue",
    "Cancel"
  );
  
  if (!firstConfirmed) {
    return;
  }
  
  // Second confirmation: require typing "DELETE"
  const confirmed = await new Promise((resolve) => {
    // Create modal
    let modal = document.getElementById("deleteConfirmModal");
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'deleteConfirmModal';
      modal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1002; align-items: center; justify-content: center;';
      document.body.appendChild(modal);
    }
    
    modal.innerHTML = `
      <div style="background: white; border-radius: var(--radius); padding: 24px; max-width: 450px; width: 90%; box-shadow: var(--shadow-hover);">
        <h3 style="margin-bottom: 12px; font-size: 18px; color: var(--accent-red);">Final Confirmation Required</h3>
        <p style="margin-bottom: 16px; font-size: 14px; color: var(--text-secondary);">
          To confirm account deletion, please type <strong>DELETE</strong> (all caps) in the field below:
        </p>
        <input type="text" id="deleteConfirmationInput" placeholder="Type DELETE to confirm" style="width: 100%; padding: 10px; border: 2px solid var(--border); border-radius: var(--radius-sm); font-size: 14px; margin-bottom: 20px; box-sizing: border-box;" autocomplete="off">
        <div style="display: flex; justify-content: flex-end; gap: 12px;">
          <button type="button" id="deleteConfirmCancel" class="btn" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border);">Cancel</button>
          <button type="button" id="deleteConfirmOk" class="btn" style="background: var(--accent-red); color: white; opacity: 0.5; cursor: not-allowed;" disabled>Delete My Account</button>
        </div>
      </div>
    `;
    
    modal.style.display = 'flex';
    const input = document.getElementById("deleteConfirmationInput");
    const okBtn = document.getElementById("deleteConfirmOk");
    const cancelBtn = document.getElementById("deleteConfirmCancel");
    
    // Enable/disable button based on input
    input.addEventListener('input', function() {
      if (input.value === "DELETE") {
        okBtn.disabled = false;
        okBtn.style.opacity = "1";
        okBtn.style.cursor = "pointer";
      } else {
        okBtn.disabled = true;
        okBtn.style.opacity = "0.5";
        okBtn.style.cursor = "not-allowed";
      }
    });
    
    // Enter key to submit if DELETE is typed
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && input.value === "DELETE") {
        okBtn.click();
      }
    });
    
    okBtn.addEventListener('click', function() {
      if (input.value === "DELETE") {
        modal.style.display = 'none';
        resolve(true);
      }
    });
    
    cancelBtn.addEventListener('click', function() {
      modal.style.display = 'none';
      resolve(false);
    });
    
    // Focus input
    setTimeout(() => input.focus(), 100);
  });
  
  if (!confirmed) {
    return;
  }
  
  // Show loading state
  const deleteBtn = document.querySelector('button[onclick="deleteAccount()"]');
  const originalText = deleteBtn ? deleteBtn.textContent : "Delete Account";
  if (deleteBtn) {
    deleteBtn.disabled = true;
    deleteBtn.textContent = "Deleting...";
  }
  
  try {
    const response = await fetch("/account/delete", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        confirmation: "DELETE"
      })
    });
    
    const result = await response.json();
    
    if (response.ok) {
      // Redirect to home page after successful deletion
      window.location.href = "/";
    } else {
      await showConfirmModal("Error", result.message || result.error || "Failed to delete account. Please try again.", "OK");
      if (deleteBtn) {
        deleteBtn.disabled = false;
        deleteBtn.textContent = originalText;
      }
    }
  } catch (err) {
    await showConfirmModal("Error", "An error occurred while deleting your account. Please try again.", "OK");
    if (deleteBtn) {
      deleteBtn.disabled = false;
      deleteBtn.textContent = originalText;
    }
  }
}
</script>
</body>
</html>
