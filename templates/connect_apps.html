<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Connect Apps ‚Äî Phi AI</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    /* Page-specific overrides */
    :root{
      --bg-primary: #ffffff;
      --bg-secondary: #f5f5f7;
      --text-primary: #1d1d1f;
      --text-secondary: #6e6e73;
      --accent-blue: #007AFF;
      --accent-blue-hover: #0051D5;
      --accent-green: #34C759;
      --accent-red: #FF3B30;
      --border: #d2d2d7;
      --border-light: #e5e5ea;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-hover: 0 4px 12px rgba(0,0,0,0.12);
      --radius: 12px;
    }

    *{ 
      box-sizing:border-box;
      margin: 0;
      padding: 0;
    }

    body{
      margin:0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      color: var(--text-primary);
      background: var(--bg-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Navigation tabs styling */
    .nav-tabs{
      display: flex;
      gap: var(--space-sm);
      margin-bottom: var(--space-xl);
      border-bottom: 1px solid var(--border-light);
      flex-wrap: wrap;
    }

    .nav-tabs a{
      padding: var(--space-md) var(--space-lg);
      color: var(--text-secondary);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      text-decoration: none;
      border-bottom: 2px solid transparent;
      transition: all var(--transition-fast);
    }

    .nav-tabs a:hover{
      color: var(--text-primary);
    }

    .nav-tabs a.active{
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* Card overrides for this page */
    .card h2{
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      margin-bottom: var(--space-md);
    }

    .app-card{
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: var(--space-lg);
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: var(--border-radius);
      margin-bottom: var(--space-md);
      gap: var(--space-lg);
    }

    .app-info{
      flex: 1;
    }

    .app-info h3{
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--space-xs);
    }

    .app-info p{
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
      margin: 0;
    }

    .app-status{
      display: flex;
      align-items: center;
      gap: var(--space-md);
      flex-wrap: wrap;
    }

    /* Button classes are now in global CSS */

    .config-section{
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-light);
    }

    .config-section label{
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .config-section input{
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      margin-top: 8px;
    }

    .config-section button{
      margin-top: 12px;
    }

    .info-box{
      background: #f0f7ff;
      border: 1px solid #d0e7ff;
      border-radius: 8px;
      padding: 12px;
      font-size: 13px;
      color: var(--text-secondary);
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <!-- Animated Wave Background -->
  <div class="bg-waves{% if waves_debug %} debug-mode{% endif %}" aria-hidden="true"></div>
  {% if waves_debug %}
  <div class="waves-debug-badge">üåä WAVES ON</div>
  {% endif %}
  
  <div class="app-container">
    <!-- Header -->
    <header class="header">
      <div class="header-inner">
        <a href="{{ url_for('account_home') }}" class="header-brand">
          <img src="{{ url_for('static', filename='images/logo.png.png') }}" alt="Phi AI" class="header-logo">
        </a>
        <nav class="header-nav">
          <a href="{{ url_for('account_home') }}" class="header-link">Dashboard</a>
          <a href="{{ url_for('account_meetings') }}" class="header-link">Meetings</a>
          {% if phi_available %}
            <a href="{{ url_for('ask_get') }}" class="header-link">Ask Phi</a>
          {% else %}
            <a href="#" class="header-link" aria-disabled="true" title="Phi is starting up" onclick="return false;" style="opacity: 0.5; cursor: not-allowed;">Ask Phi</a>
          {% endif %}
          <a href="{{ url_for('connect_apps_get') }}" class="header-link active">Connect Apps</a>
          <a href="{{ url_for('account_get') }}" class="header-link">Settings</a>
          <a href="{{ url_for('logout') }}" class="header-link">Logout</a>
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <div class="nav-tabs">
        <a href="{{ url_for('account_home') }}">Dashboard</a>
        <a href="{{ url_for('account_meetings') }}">Past Meetings</a>
        <a href="{{ url_for('connect_apps_get') }}" class="active">Connect Apps</a>
        <a href="{{ url_for('account_get') }}">Settings</a>
        <a href="{{ url_for('logout') }}">Logout</a>
      </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="card">
          {% for m in messages %}
            <div style="padding: 12px; background: #f0fff4; border: 1px solid #c0ffc0; border-radius: 8px; color: #2e7d32; margin-bottom: 8px;">{{ m }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="card">
      <h2>Cloud Storage Integrations</h2>
      <p>Connect your cloud storage accounts to automatically save meeting transcripts and PDFs. Files will be uploaded to your personal account after each meeting is processed.</p>
    </div>

    <!-- Dropbox Card -->
    <div class="card">
      <div class="app-card">
        <div class="app-info">
          <h3>üì¶ Dropbox</h3>
          <p>Save meetings to your Dropbox folder</p>
        </div>
        <div class="app-status">
          {% if connected_apps.get('dropbox') %}
            {% if connected_apps['dropbox'].get('needs_reauth') %}
            <span class="badge badge-warning">‚ö†Ô∏è Needs Reconnect</span>
            <a href="{{ url_for('dropbox_authorize') }}" class="btn btn-primary">Reconnect Dropbox</a>
            <button onclick="disconnectApp('dropbox')" class="btn btn-danger">Disconnect</button>
            {% else %}
            <span class="badge badge-success">‚úì Connected</span>
            <button onclick="disconnectApp('dropbox')" class="btn btn-danger">Disconnect</button>
            {% endif %}
          {% else %}
          <span class="badge badge-neutral">Not Connected</span>
          <a href="{{ url_for('dropbox_authorize') }}" class="btn btn-primary">Connect Dropbox</a>
          {% endif %}
        </div>
      </div>
      
      {% if connected_apps.get('dropbox') %}
      <div class="config-section">
        {% if connected_apps['dropbox'].get('needs_reauth') %}
        <div class="info-box" style="background: #fff3cd; border-color: #ffc107; color: #856404;">
          <strong>‚ö†Ô∏è Action Required:</strong> Your Dropbox access token expired and cannot be refreshed because we don't have a refresh token (or app credentials) to refresh it.<br><br>
          <strong>To fix:</strong> Click "Reconnect Dropbox" above, or Disconnect then Connect again. After reconnecting, run one test upload to confirm.
        </div>
        {% endif %}
        <label>Folder Path</label>
        <input type="text" id="dropbox_folder" value="{{ connected_apps['dropbox'].get('folder_path', '/PhiAI/Meetings') }}" placeholder="/PhiAI/Meetings">
        <button onclick="updateAppConfig('dropbox')" class="btn btn-primary">Update Folder Path</button>
        <div class="info-box">
          <strong>Connected:</strong> {{ connected_apps['dropbox'].get('connected_at', '')[:10] }}<br>
          Files will be saved to this folder path in your Dropbox account.
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Google Drive Card -->
    <div class="card">
      <div class="app-card">
        <div class="app-info">
          <h3>‚òÅÔ∏è Google Drive</h3>
          <p>Save meetings to your Google Drive</p>
        </div>
        <div class="app-status">
          {% if connected_apps.get('googledrive') %}
            {% if connected_apps['googledrive'].get('needs_reauth') %}
            <span class="badge badge-warning">‚ö†Ô∏è Needs Reconnect</span>
            <a href="{{ url_for('googledrive_authorize') }}" class="btn btn-primary">Reconnect Google Drive</a>
            <button onclick="disconnectApp('googledrive')" class="btn btn-danger">Disconnect</button>
            {% else %}
            <span class="badge badge-success">‚úì Connected</span>
            <button onclick="disconnectApp('googledrive')" class="btn btn-danger">Disconnect</button>
            {% endif %}
          {% else %}
          <span class="badge badge-neutral">Not Connected</span>
          <a href="{{ url_for('googledrive_authorize') }}" class="btn btn-primary">Connect Google Drive</a>
          {% endif %}
        </div>
      </div>
      
      {% if connected_apps.get('googledrive') %}
      <div class="config-section">
        <label>Folder Name</label>
        <input type="text" id="googledrive_folder" value="{{ connected_apps['googledrive'].get('folder_name', 'PhiAI Meetings') }}" placeholder="PhiAI Meetings">
        <button onclick="updateAppConfig('googledrive')" class="btn btn-primary">Update Folder Name</button>
        <div class="info-box">
          <strong>Connected:</strong> {{ connected_apps['googledrive'].get('connected_at', '')[:10] }}<br>
          A folder with this name will be created in your Google Drive (if it doesn't exist).
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Box Card -->
    <div class="card">
      <div class="app-card">
        <div class="app-info">
          <h3>üìÅ Box</h3>
          <p>Save meetings to your Box folder</p>
        </div>
        <div class="app-status">
          {% if connected_apps.get('box') %}
            {% set box_needs_scopes = box_diagnostics and (box_diagnostics.get('needs_scope_update') or (not box_diagnostics.get('write_scope_ok') and box_diagnostics.get('last_scope_error'))) %}
            {% if box_needs_scopes %}
            <span class="badge badge-warning">üîí Needs Permissions</span>
            <a href="{{ url_for('box_authorize') }}" class="btn btn-primary">Reconnect Box</a>
            <button onclick="disconnectApp('box')" class="btn btn-danger">Disconnect</button>
            {% elif connected_apps['box'].get('needs_reauth') %}
            <span class="badge badge-warning">‚ö†Ô∏è Needs Reconnect</span>
            <a href="{{ url_for('box_authorize') }}" class="btn btn-primary">Reconnect Box</a>
            <button onclick="disconnectApp('box')" class="btn btn-danger">Disconnect</button>
            {% else %}
            <span class="badge badge-success">‚úì Connected</span>
            <button onclick="disconnectApp('box')" class="btn btn-danger">Disconnect</button>
            {% endif %}
          {% else %}
          <span class="badge badge-neutral">Not Connected</span>
          <a href="{{ url_for('box_authorize') }}" class="btn btn-primary">Connect Box</a>
          {% endif %}
        </div>
      </div>
      
      {% if connected_apps.get('box') %}
      <div class="config-section">
        {% set box_needs_scopes = box_diagnostics and (box_diagnostics.get('needs_scope_update') or (not box_diagnostics.get('write_scope_ok') and box_diagnostics.get('last_scope_error'))) %}
        
        {% if box_needs_scopes %}
        <!-- Box Permissions Checklist Card -->
        <div class="box-permissions-card" style="background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%); border: 2px solid #ff6b6b; border-radius: var(--radius); padding: var(--space-lg); margin-bottom: var(--space-lg); box-shadow: 0 4px 12px rgba(255, 107, 107, 0.15);">
          <div style="display: flex; align-items: center; gap: var(--space-md); margin-bottom: var(--space-md);">
            <div style="font-size: 24px;">üîí</div>
            <h3 style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); color: #c92a2a; margin: 0;">Box Needs Write Permission</h3>
          </div>
          
          <p style="color: #862e2e; margin-bottom: var(--space-lg); line-height: 1.6;">
            Your Box connection is missing write permissions. Follow the steps below to fix this.
          </p>
          
          <div style="background: white; border-radius: 8px; padding: var(--space-lg); margin-bottom: var(--space-md);">
            <h4 style="font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); color: var(--text-primary); margin-bottom: var(--space-md); display: flex; align-items: center; gap: var(--space-sm);">
              <span style="color: #ff6b6b;">üë®‚Äçüíª</span>
              Developer Steps (One-Time Setup)
            </h4>
            <ol style="margin-left: var(--space-lg); color: var(--text-secondary); line-height: 1.8; font-size: var(--font-size-sm);">
              <li>Go to <a href="https://developer.box.com/" target="_blank" style="color: var(--accent); text-decoration: none; font-weight: 500;">Box Developer Console</a></li>
              <li>Navigate to <strong>My Apps</strong> ‚Üí Select your app ‚Üí <strong>Configuration</strong></li>
              <li>Scroll to <strong>Application Scopes</strong> section</li>
              <li>Enable: <strong>"Read and write all files and folders stored in Box"</strong></li>
              <li>Click <strong>Save Changes</strong> (important!)</li>
              <li>Wait 2-3 minutes for changes to propagate</li>
            </ol>
          </div>
          
          <div style="background: white; border-radius: 8px; padding: var(--space-lg); margin-bottom: var(--space-md);">
            <h4 style="font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); color: var(--text-primary); margin-bottom: var(--space-md); display: flex; align-items: center; gap: var(--space-sm);">
              <span style="color: #4dabf7;">üë§</span>
              User Steps (Required After Scope Change)
            </h4>
            <ol style="margin-left: var(--space-lg); color: var(--text-secondary); line-height: 1.8; font-size: var(--font-size-sm);">
              <li>In this page: Click <strong>Disconnect</strong> button above</li>
              <li>Click <strong>Connect Box</strong> to re-authorize</li>
              <li>Authorize the app when prompted</li>
            </ol>
            <p style="margin-top: var(--space-md); padding: var(--space-md); background: #e7f5ff; border-left: 3px solid #4dabf7; border-radius: 4px; font-size: var(--font-size-sm); color: #1864ab;">
              <strong>Why reconnect?</strong> Existing tokens won't gain new permissions until you re-authorize. This is a Box security requirement.
            </p>
          </div>
          
          <div style="display: flex; gap: var(--space-md); flex-wrap: wrap; margin-top: var(--space-lg);">
            <button onclick="recheckBoxPermissions()" class="btn btn-primary" style="flex: 1; min-width: 200px;">
              üîÑ I Updated Scopes ‚Äî Recheck Now
            </button>
            <button onclick="disconnectApp('box')" class="btn btn-secondary" style="flex: 1; min-width: 200px;">
              Disconnect Box
            </button>
            <a href="{{ url_for('box_authorize') }}" class="btn btn-primary" style="flex: 1; min-width: 200px; text-align: center; text-decoration: none;">
              Reconnect Box
            </a>
          </div>
          
          {% if box_diagnostics and box_diagnostics.get('last_scope_error') %}
          <div style="margin-top: var(--space-md); padding: var(--space-md); background: rgba(255, 255, 255, 0.8); border-radius: 6px; font-size: var(--font-size-sm); color: #862e2e;">
            <strong>Last Error:</strong> {{ box_diagnostics.get('last_scope_error')[:200] }}
          </div>
          {% endif %}
        </div>
        {% elif connected_apps['box'].get('needs_reauth') %}
        <div class="info-box" style="background: #fff3cd; border-color: #ffc107; color: #856404;">
          <strong>‚ö†Ô∏è Action Required:</strong> Your Box access token expired and cannot be refreshed.<br><br>
          <strong>To fix:</strong> Click "Reconnect Box" above, or Disconnect then Connect again.
        </div>
        {% elif box_diagnostics and box_diagnostics.get('write_scope_ok') %}
        <div class="info-box" style="background: #d4edda; border-color: #28a745; color: #155724;">
          <strong>‚úÖ Write Permissions Verified</strong><br>
          {% if box_diagnostics.get('write_scope_verified_at') %}
          Last verified: {{ box_diagnostics.get('write_scope_verified_at')[:10] }}
          {% endif %}
        </div>
        {% endif %}
        
        <label>Folder Name</label>
        <input type="text" id="box_folder" value="{{ connected_apps['box'].get('folder_name', 'PhiAI Meetings') }}" placeholder="PhiAI Meetings">
        <button onclick="updateAppConfig('box')" class="btn btn-primary">Update Folder Name</button>
        <div class="info-box">
          <strong>Connected:</strong> {{ connected_apps['box'].get('connected_at', '')[:10] }}<br>
          A folder with this name will be created in your Box account (if it doesn't exist).
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: var(--radius); padding: 24px; max-width: 400px; width: 90%; box-shadow: var(--shadow-hover);">
      <h2 id="confirmTitle" style="font-size: 20px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);"></h2>
      <p id="confirmMessage" style="font-size: 15px; color: var(--text-secondary); margin-bottom: 24px; line-height: 1.5;"></p>
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button id="confirmCancel" class="btn" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border);"></button>
        <button id="confirmOk" class="btn btn-primary"></button>
      </div>
    </div>
  </div>

  <script>
    function showConfirmModal(title, message, okText = "OK", cancelText = "Cancel") {
      return new Promise((resolve) => {
        const modal = document.getElementById("confirmModal");
        const titleEl = document.getElementById("confirmTitle");
        const messageEl = document.getElementById("confirmMessage");
        const okBtn = document.getElementById("confirmOk");
        const cancelBtn = document.getElementById("confirmCancel");
        
        titleEl.textContent = title;
        messageEl.textContent = message;
        okBtn.textContent = okText;
        cancelBtn.textContent = cancelText;
        
        modal.style.display = "flex";
        
        const handleOk = () => {
          modal.style.display = "none";
          okBtn.onclick = null;
          cancelBtn.onclick = null;
          resolve(true);
        };
        
        const handleCancel = () => {
          modal.style.display = "none";
          okBtn.onclick = null;
          cancelBtn.onclick = null;
          resolve(false);
        };
        
        okBtn.onclick = handleOk;
        cancelBtn.onclick = handleCancel;
        
        modal.onclick = (e) => {
          if (e.target === modal) {
            handleCancel();
          }
        };
      });
    }

    async function disconnectApp(appName) {
      const appDisplayName = appName === 'googledrive' ? 'Google Drive' : appName.charAt(0).toUpperCase() + appName.slice(1);
      const confirmed = await showConfirmModal(
        `Disconnect ${appDisplayName}`,
        `Are you sure you want to disconnect ${appDisplayName}? Meeting files will no longer be automatically saved to your account.`,
        "Disconnect",
        "Cancel"
      );
      
      if (!confirmed) return;
      
      try {
        const response = await fetch(`/connect/${appName}/disconnect`, { method: "POST" });
        const result = await response.json();
        
        if (response.ok) {
          window.location.reload();
        } else {
          await showConfirmModal("Error", result.error || "Failed to disconnect. Please try again.", "OK");
        }
      } catch (err) {
        await showConfirmModal("Error", "An error occurred. Please try again.", "OK");
      }
    }

    async function recheckBoxPermissions() {
      const button = event.target;
      const originalText = button.textContent;
      button.disabled = true;
      button.textContent = "üîÑ Checking...";
      
      try {
        const response = await fetch('/connect/box/recheck', { method: 'POST' });
        const result = await response.json();
        
        if (result.status === 'success') {
          await showConfirmModal(
            "‚úÖ Permissions Verified",
            result.message || "Box write permissions are working correctly!",
            "OK"
          );
          // Reload page to update UI
          window.location.reload();
        } else {
          await showConfirmModal(
            "‚ö†Ô∏è Permissions Still Missing",
            result.message || "Write permissions are still not available. Make sure you've completed all the steps in the checklist above.",
            "OK"
          );
          // Reload page to update UI
          window.location.reload();
        }
      } catch (err) {
        await showConfirmModal("Error", "Failed to recheck permissions. Please try again.", "OK");
        button.disabled = false;
        button.textContent = originalText;
      }
    }

    async function updateAppConfig(appName) {
      let folderValue;
      if (appName === 'dropbox') {
        folderValue = document.getElementById('dropbox_folder').value.trim();
        if (!folderValue) {
          await showConfirmModal("Error", "Folder path is required.", "OK");
          return;
        }
      } else {
        folderValue = document.getElementById(`${appName}_folder`).value.trim();
        if (!folderValue) {
          await showConfirmModal("Error", "Folder name is required.", "OK");
          return;
        }
      }
      
      const formData = new FormData();
      if (appName === 'dropbox') {
        formData.append('folder_path', folderValue);
      } else {
        formData.append('folder_name', folderValue);
      }
      
      try {
        const response = await fetch(`/connect/${appName}/update`, {
          method: "POST",
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          await showConfirmModal("Success", "Configuration updated successfully!", "OK");
          window.location.reload();
        } else {
          await showConfirmModal("Error", result.error || "Failed to update configuration.", "OK");
        }
      } catch (err) {
        await showConfirmModal("Error", "An error occurred. Please try again.", "OK");
      }
    }
  </script>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-inner">
      <p>&copy; 2026 Phi AI. All rights reserved.</p>
      <p style="margin-top: var(--space-sm); font-size: var(--font-size-sm); color: var(--text-secondary);">189 Vassar St, Cambridge, MA 02139</p>
    </div>
  </footer>
</body>
</html>
